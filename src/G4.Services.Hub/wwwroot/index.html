<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title>G4™ Engine API - Blueprint Designer</title>

	<link rel="icon" href="./images/favicon.ico" />
	<link href="./css/designer.css" rel="stylesheet">
	<link href="./css/designer-blueprint-parameters.css" rel="stylesheet" id="theme-stylesheet" />
	<link href="./css/designer-blueprint-spinner.css" rel="stylesheet" />
	<link href="./css/designer-blueprint-layout.css" rel="stylesheet" />
	<link href="./css/designer-blueprint-appearance.css" rel="stylesheet" />
</head>

<body class="sqd-theme-light">
	<script type="text/javascript">
		/**
		 * Immediately invoked function to check if the URL query string contains ?mode=dark.
		 * If so, the dark theme is applied automatically on page load.
		 */
		(function () {
			// Parse the URL parameters from the current window location.
			const urlParams = new URLSearchParams(window.location.search);

			// Check if the 'mode' parameter is set to 'dark'. If not, exit the function.
			if (urlParams.get('mode') !== 'dark') {
				return;
			}

			// If 'mode' is 'dark', switch the theme by updating the stylesheet's 'href' attribute.
			document
				.getElementById('theme-stylesheet')
				.setAttribute('href', './css/designer-blueprint-parameters-dark.css');
		})();
	</script>

	<div id="loading-indicator">
		<div id="spinner">
			<span></span>
			<span></span>
			<span></span>
			<span></span>
			<span></span>
		</div>
	</div>

	<div id="app">
		<div id="designer--header" class="sqd-header">
			<div class="column">
				<!-- Button to toggle the theme -->
				<div class="sqd-title">G4&trade; Engine API</div>
				<div class="sqd-subtitle">Blueprint Designer for Automation Workflows</div>
				<div class="sqd-text--tiny sqd-margin-top-03">Powered by <b><a href="https://github.com/nocode-js/sequential-workflow-designer" target="_blank">Sequential Workflow Designer</a></b></div>
				<div class="sqd-text--tiny sqd-margin-top-03">Powered by <b><a href="https://github.com/g4-api/g4-services" target="_blank">G4&trade; Engine</a></b></div>
			</div>
			<div class="column sqd-card">
				<div class="sqd-card--label">Actions Invoked</div>
				<div id="designer--total-actions" class="sqd-card--content">0</div>
			</div>
			<div class="column sqd-card">
				<div class="sqd-card--label">Avg. Action Time (sec.)</div>
				<div id="designer--average-action-time" class="sqd-card--content">0.00</div>
			</div>
			<div class="column sqd-card">
				<div class="sqd-card--label">Time Elapsed</div>
				<div id="designer--timer" class="sqd-card--content">00:00:00</div>
			</div>
		</div>

		<div id="designer" class="sqd-content"></div>

		<div id="designer--bottom" class="sqd-footer">
			<div>Column 1</div>
			<div>Column 2</div>
			<div>Column 3</div>
		</div>

	</div>

	<script src="./js/metric-utilities.js"></script>
	<script src="./js/utilities.js"></script>
	<script src="./js/validators.js"></script>
	<script src="./js/observer.js"></script>
	<script src="./js/cli-factory.js"></script>
	<script src="./js/signalr.min.js" integrity="" crossorigin="anonymous"></script>
	<script src="./js/g4-client.js"></script>
	<script src="./js/global.js"></script>
	<script src="./js/custom-fields.js"></script>
	<script src="./js/index.umd.js"></script>
	<script src="./js/state-machine.js"></script>
	<script src="./js/index.js"></script>

	<script>
		// Create a new instance of the G4Client class
		const client = new G4Client();

		/**
		 * Fetches an SVG resource from the given URI and returns its raw text.
		 */
		const resolveSvg = async (uri) => {
			// Perform a network request to fetch the resource at the provided URI
			const response = await fetch(uri);

			// If the HTTP status indicates success (status in the range 200–299),
			// return the response body as text; otherwise, return null
			return response.ok
				? await response.text()
				: null;
		};

		/**
		 * Waits for the '.sqd-control-bar' element to appear in the DOM within a specified timeout,
		 * then adds custom control bar buttons for exporting, importing, starting, and stopping definitions.
		 *
		 * @param {string} selector - The CSS selector of the element to wait for.
		 * @param {number} timeout  - The maximum time to wait for the element in milliseconds.
		 */
		Utilities.waitForElement('.sqd-control-bar', 5000)
			.then(async (controlBar) => {
				// SVG path data for the Export button icon
				const exportSvg = "M352 173.3L352 384C352 401.7 337.7 416 320 416C302.3 416 288 401.7 288 384L288 173.3L246.6 214.7C234.1 227.2 213.8 227.2 201.3 214.7C188.8 202.2 188.8 181.9 201.3 169.4L297.3 73.4C309.8 60.9 330.1 60.9 342.6 73.4L438.6 169.4C451.1 181.9 451.1 202.2 438.6 214.7C426.1 227.2 405.8 227.2 393.3 214.7L352 173.3zM320 464C364.2 464 400 428.2 400 384L480 384C515.3 384 544 412.7 544 448L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 448C96 412.7 124.7 384 160 384L240 384C240 428.2 275.8 464 320 464zM464 488C477.3 488 488 477.3 488 464C488 450.7 477.3 440 464 440C450.7 440 440 450.7 440 464C440 477.3 450.7 488 464 488z";

				// SVG path data for the Import button icon
				const importSvg = "M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 306.7L246.6 265.3C234.1 252.8 213.8 252.8 201.3 265.3C188.8 277.8 188.8 298.1 201.3 310.6L297.3 406.6C309.8 419.1 330.1 419.1 342.6 406.6L438.6 310.6C451.1 298.1 451.1 277.8 438.6 265.3C426.1 252.8 405.8 252.8 393.3 265.3L352 306.7L352 96zM160 384C124.7 384 96 412.7 96 448L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 448C544 412.7 515.3 384 480 384L433.1 384L376.5 440.6C345.3 471.8 294.6 471.8 263.4 440.6L206.9 384L160 384zM464 440C477.3 440 488 450.7 488 464C488 477.3 477.3 488 464 488C450.7 488 440 477.3 440 464C440 450.7 450.7 440 464 440z";

				// SVG path data for the Start button icon
				const startSvg = "M187.2 100.9C174.8 94.1 159.8 94.4 147.6 101.6C135.4 108.8 128 121.9 128 136L128 504C128 518.1 135.5 531.2 147.6 538.4C159.7 545.6 174.8 545.9 187.2 539.1L523.2 355.1C536 348.1 544 334.6 544 320C544 305.4 536 291.9 523.2 284.9L187.2 100.9z";

				// SVG path data for the Stop button icon
				const stopSvg = "M160 96L480 96C515.3 96 544 124.7 544 160L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 160C96 124.7 124.7 96 160 96z";

				// SVG path data for the Reset button icon
				const resetSvg = "M500.7 138.7L512 149.4L512 96C512 78.3 526.3 64 544 64C561.7 64 576 78.3 576 96L576 224C576 241.7 561.7 256 544 256L416 256C398.3 256 384 241.7 384 224C384 206.3 398.3 192 416 192L463.9 192L456.3 184.8C456.1 184.6 455.9 184.4 455.7 184.2C380.7 109.2 259.2 109.2 184.2 184.2C109.2 259.2 109.2 380.7 184.2 455.7C259.2 530.7 380.7 530.7 455.7 455.7C463.9 447.5 471.2 438.8 477.6 429.6C487.7 415.1 507.7 411.6 522.2 421.7C536.7 431.8 540.2 451.8 530.1 466.3C521.6 478.5 511.9 490.1 501 501C401 601 238.9 601 139 501C39.1 401 39 239 139 139C238.9 39.1 400.7 39 500.7 138.7z";

				// SVG path data for the Dark Mode button icon
				const darkModeSvg = "M512 320C512 214 426 128 320 128L320 512C426 512 512 426 512 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320z";

				// Create a container div for the custom buttons
				const customButtonsContainer = document.createElement("div");

				// Set a custom data attribute for identification
				customButtonsContainer.setAttribute('data-g4-role', 'custom-buttons');

				/**
				 * Creates and configures the Dark Mode button.
				 */
				CustomG4Fields.newControlBarButton({
					classList: ['sqd-control-bar-button'],
					container: customButtonsContainer,
					icon: darkModeSvg,
					pathClassList: ['sqd-icon-path'],
					svgClassList: ['sqd-control-bar-button-icon'],
					title: 'Dark/Light Mode',
					viewBox: '0 0 640 640',
					onClick: () => {
						Utilities.switchMode();
					}
				});

				/**
				 * Creates and configures the Reset Definition button.
				 */
				CustomG4Fields.newControlBarButton({
					classList: ['sqd-control-bar-button'],
					container: customButtonsContainer,
					icon: resetSvg,
					pathClassList: ['sqd-icon-path'],
					svgClassList: ['sqd-control-bar-button-icon'],
					title: 'Reset Definition',
					viewBox: '0 0 640 640',
					svgElementHtml: null,
					onClick: () => {
						// Indicate that the automation is no longer running
						_stateMachine.isRunning = false;

						// Release the designer from read-only mode
						_designer.setIsReadonly(false);
					}
				});

				/**
				 * Creates and configures the Export Definition button.
				 */
				CustomG4Fields.newControlBarButton({
					classList: ['sqd-control-bar-button'],
					container: customButtonsContainer,
					icon: exportSvg,
					pathClassList: ['sqd-icon-path'],
					svgClassList: ['sqd-control-bar-button-icon'],
					title: 'Export Definition',
					viewBox: '0 0 640 640',
					onClick: exportDefinition
				});

				/**
				 * Creates and configures the Import Definition button.
				 */
				CustomG4Fields.newControlBarButton({
					classList: ['sqd-control-bar-button'],
					container: customButtonsContainer,
					icon: importSvg,
					pathClassList: ['sqd-icon-path'],
					svgClassList: ['sqd-control-bar-button-icon'],
					title: 'Import Definition',
					viewBox: '0 0 640 640',
					onClick: newImportModal
				});

				/**
				 * Creates and configures the Stop Definition button.
				 */
				CustomG4Fields.newControlBarButton({
					classList: ['sqd-control-bar-button'],
					container: customButtonsContainer,
					icon: stopSvg,
					pathClassList: ['sqd-icon-path', 'sqd-stop-icon-path'],
					svgClassList: ['sqd-control-bar-button-icon'],
					title: 'Stop Definition',
					viewBox: '0 0 640 640',
					// Event handler for stopping the definition process
					onClick: stopDefinition
				});

				/**
				 * Creates and configures the Start Definition button.
				 */
				CustomG4Fields.newControlBarButton({
					classList: ['sqd-control-bar-button'],
					container: customButtonsContainer,
					icon: startSvg,
					pathClassList: ['sqd-icon-path', 'sqd-start-icon-path'],
					svgClassList: ['sqd-control-bar-button-icon'],
					title: 'Start Definition',
					viewBox: '0 0 640 640',
					// Event handler for starting the definition process
					onClick: startDefinition
				});

				// Append the container with custom buttons to the existing control bar
				controlBar.appendChild(customButtonsContainer);
			})
			.catch((error) => {
				// Handle any errors that occur while waiting for the element
				console.error(`Error waiting for element: ${error.message}`);
			});
	</script>
</body>

</html>